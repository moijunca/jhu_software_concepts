<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>load_data &#8212; GradCafe Analytics 4.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=3304f9e4"></script>
    <script src="../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for load_data</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">load_data.py – ETL: parse JSONL from the LLM-extended dataset and insert rows</span>
<span class="sd">into the PostgreSQL ``applicants`` table.</span>

<span class="sd">Changes from Module 3:</span>
<span class="sd">- Uses psycopg3 (``import psycopg``) instead of psycopg2.</span>
<span class="sd">- ``get_conn()`` / ``ensure_index()`` / ``main()`` accept an optional Flask</span>
<span class="sd">  ``app`` object so that tests can inject a ``DATABASE_URL`` via</span>
<span class="sd">  ``app.config`` without touching environment variables.</span>
<span class="sd">- ``_build_conninfo()`` mirrors the helper in ``app.py``.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">psycopg</span>  <span class="c1"># psycopg3</span>

<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Paths</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>  <span class="c1"># module_4/data/</span>

<span class="n">LIV_LLM_JSONL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;llm_extend_applicant_data.json&quot;</span><span class="p">)</span>

<span class="n">FALL_2026</span> <span class="o">=</span> <span class="s2">&quot;Fall 2026&quot;</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># DB helpers</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_build_conninfo</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a psycopg3-compatible connection string.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">app</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="n">db</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PGDATABASE&quot;</span><span class="p">,</span> <span class="s2">&quot;gradcafe&quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PGUSER&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;postgres&quot;</span><span class="p">))</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PGHOST&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PGPORT&quot;</span><span class="p">,</span> <span class="s2">&quot;5432&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;dbname=</span><span class="si">{</span><span class="n">db</span><span class="si">}</span><span class="s2"> user=</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> host=</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2"> port=</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="get_conn">
<a class="viewcode-back" href="../api.html#load_data.get_conn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_conn</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open and return a psycopg3 connection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">psycopg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_build_conninfo</span><span class="p">(</span><span class="n">app</span><span class="p">))</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Cleaning / parsing helpers</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="clean_text">
<a class="viewcode-back" href="../api.html#load_data.clean_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_text</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert to str, strip, and remove NUL bytes that crash psycopg.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span> <span class="k">else</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="to_float">
<a class="viewcode-back" href="../api.html#load_data.to_float">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Coerce a value to float, returning None on failure.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="parse_date">
<a class="viewcode-back" href="../api.html#load_data.parse_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_date</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse various date strings.</span>

<span class="sd">    Supported formats: ``&quot;January 31, 2026&quot;``, ``&quot;Feb 1, 2026&quot;``,</span>
<span class="sd">    ``&quot;2026-02-01&quot;``, ``&quot;02/01/2026&quot;``.</span>
<span class="sd">    Returns a :class:`datetime.date` or ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">,</span> <span class="s2">&quot;%b </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fmt</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Term extraction</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="n">TERM_FULL_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(Fall|Spring|Summer|Winter|Autumn)\s*[&#39;&#39;]?\s*(20\d</span><span class="si">{2}</span><span class="s2">|\d</span><span class="si">{2}</span><span class="s2">)\b&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">TERM_SHORT_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(F|S|SU|W)\s*[&#39;&#39;]?\s*(\d</span><span class="si">{2}</span><span class="s2">)\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">TERM_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="s2">&quot;Fall&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Spring&quot;</span><span class="p">,</span> <span class="s2">&quot;SU&quot;</span><span class="p">:</span> <span class="s2">&quot;Summer&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="s2">&quot;Winter&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="extract_term">
<a class="viewcode-back" href="../api.html#load_data.extract_term">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_term</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a normalised semester/year term string from free text.&quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">TERM_FULL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;20</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">season</span> <span class="o">==</span> <span class="s2">&quot;Autumn&quot;</span><span class="p">:</span>
            <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;Fall&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">TERM_SHORT_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">year2</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">season</span> <span class="o">=</span> <span class="n">TERM_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">season</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2"> 20</span><span class="si">{</span><span class="n">year2</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Status / nationality</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="n">DECISION_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(Accepted|Rejected|Waitlisted|Wait listed|Interview)\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
<span class="p">)</span>
<span class="n">AMERICAN_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bAmerican\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<span class="n">INTL_RE</span>     <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bInternational\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>


<div class="viewcode-block" id="extract_status">
<a class="viewcode-back" href="../api.html#load_data.extract_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_status</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract an admission decision string from free text.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">DECISION_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">raw</span> <span class="o">==</span> <span class="s2">&quot;waitlisted&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Waitlisted&quot;</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span></div>



<div class="viewcode-block" id="extract_us_intl">
<a class="viewcode-back" href="../api.html#load_data.extract_us_intl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_us_intl</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return ``&#39;International&#39;``, ``&#39;American&#39;``, or ``None``.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">INTL_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;International&quot;</span>
    <span class="k">if</span> <span class="n">AMERICAN_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;American&quot;</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Degree normalisation</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="normalize_degree">
<a class="viewcode-back" href="../api.html#load_data.normalize_degree">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_degree</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalise a degree string to ``&#39;PhD&#39;``, ``&#39;Masters&#39;``, ``&#39;Bachelors&#39;``, or raw.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;phd&quot;</span> <span class="ow">in</span> <span class="n">lo</span> <span class="ow">or</span> <span class="s2">&quot;ph.d&quot;</span> <span class="ow">in</span> <span class="n">lo</span> <span class="ow">or</span> <span class="s2">&quot;doctor&quot;</span> <span class="ow">in</span> <span class="n">lo</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;PhD&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;master&quot;</span> <span class="ow">in</span> <span class="n">lo</span> <span class="ow">or</span> <span class="n">lo</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;m.s.&quot;</span><span class="p">,</span> <span class="s2">&quot;msc&quot;</span><span class="p">,</span> <span class="s2">&quot;mcs&quot;</span><span class="p">,</span> <span class="s2">&quot;meng&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Masters&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;bachelor&quot;</span> <span class="ow">in</span> <span class="n">lo</span> <span class="ow">or</span> <span class="n">lo</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="s2">&quot;b.s.&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Bachelors&quot;</span>
    <span class="k">return</span> <span class="n">s</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># GPA / GRE extraction</span>
<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="n">GPA_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(?:GPA\s*[:=]?\s*)?([0-4]\.\d{1,2})\s*(?:master&#39;?s\s*)?(?:GPA)?\b&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">GRE_Q_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(?:GRE\s*)?(?:Q(?:uant)?|Quant|Quantitative)\s*[:=]?\s*(\d</span><span class="si">{3}</span><span class="s2">)\b&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;|\b(\d</span><span class="si">{3}</span><span class="s2">)\s*Q\b&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">GRE_V_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(?:GRE\s*)?(?:V(?:erb)?|Verbal)\s*[:=]?\s*(\d</span><span class="si">{3}</span><span class="s2">)\b&quot;</span>
    <span class="sa">r</span><span class="s2">&quot;|\b(\d</span><span class="si">{3}</span><span class="s2">)\s*V\b&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">GRE_AW_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\b(?:AWA|AW|Analytical Writing)\s*[:=]?\s*([0-6]\.\d)\b&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="extract_gpa_gre">
<a class="viewcode-back" href="../api.html#load_data.extract_gpa_gre">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_gpa_gre</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract GPA, GRE Quant, GRE Verbal, and GRE AW from free text.</span>

<span class="sd">    Returns a 4-tuple ``(gpa, gre_q, gre_v, gre_aw)`` where each element is</span>
<span class="sd">    a ``float`` or ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>

    <span class="n">gpa</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">GPA_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">gpa</span> <span class="o">=</span> <span class="n">to_float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">gre_q</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">GRE_Q_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">gre_q</span> <span class="o">=</span> <span class="n">to_float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">gre_v</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">GRE_V_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">gre_v</span> <span class="o">=</span> <span class="n">to_float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">gre_aw</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">GRE_AW_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">gre_aw</span> <span class="o">=</span> <span class="n">to_float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">gre_q</span><span class="p">,</span> <span class="n">gre_v</span><span class="p">,</span> <span class="n">gre_aw</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># JSONL loader</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="load_jsonl">
<a class="viewcode-back" href="../api.html#load_data.load_jsonl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_jsonl</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stream JSONL (one JSON object per line), skipping malformed lines.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Schema / index helpers</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="ensure_table">
<a class="viewcode-back" href="../api.html#load_data.ensure_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_table</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the ``applicants`` table and its unique index if they do not exist.</span>

<span class="sd">    Safe to call repeatedly (idempotent).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE IF NOT EXISTS applicants (</span>
<span class="s2">                    p_id                    SERIAL PRIMARY KEY,</span>
<span class="s2">                    program                 TEXT,</span>
<span class="s2">                    comments                TEXT,</span>
<span class="s2">                    date_added              DATE,</span>
<span class="s2">                    url                     TEXT,</span>
<span class="s2">                    status                  TEXT,</span>
<span class="s2">                    term                    TEXT,</span>
<span class="s2">                    us_or_international     TEXT,</span>
<span class="s2">                    gpa                     NUMERIC,</span>
<span class="s2">                    gre                     NUMERIC,</span>
<span class="s2">                    gre_v                   NUMERIC,</span>
<span class="s2">                    gre_aw                  NUMERIC,</span>
<span class="s2">                    degree                  TEXT,</span>
<span class="s2">                    llm_generated_program   TEXT,</span>
<span class="s2">                    llm_generated_university TEXT</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE UNIQUE INDEX IF NOT EXISTS applicants_sig_unique</span>
<span class="s2">                ON applicants (</span>
<span class="s2">                    COALESCE(url, &#39;&#39;),</span>
<span class="s2">                    COALESCE(program, &#39;&#39;),</span>
<span class="s2">                    COALESCE(comments, &#39;&#39;)</span>
<span class="s2">                );</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="ensure_index">
<a class="viewcode-back" href="../api.html#load_data.ensure_index">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_index</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deduplicate existing rows and ensure the unique index exists.</span>

<span class="sd">    Used by ``main()`` before bulk-inserting to guarantee idempotency on</span>
<span class="sd">    tables that may have been populated without the index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DO $$</span>
<span class="s2">    BEGIN</span>
<span class="s2">      WITH ranked AS (</span>
<span class="s2">        SELECT</span>
<span class="s2">          p_id,</span>
<span class="s2">          ROW_NUMBER() OVER (</span>
<span class="s2">            PARTITION BY</span>
<span class="s2">              COALESCE(url, &#39;&#39;),</span>
<span class="s2">              COALESCE(program, &#39;&#39;),</span>
<span class="s2">              COALESCE(comments, &#39;&#39;)</span>
<span class="s2">            ORDER BY p_id</span>
<span class="s2">          ) AS rn</span>
<span class="s2">        FROM applicants</span>
<span class="s2">      )</span>
<span class="s2">      DELETE FROM applicants</span>
<span class="s2">      WHERE p_id IN (SELECT p_id FROM ranked WHERE rn &gt; 1);</span>

<span class="s2">      IF NOT EXISTS (</span>
<span class="s2">        SELECT 1 FROM pg_indexes</span>
<span class="s2">        WHERE schemaname = &#39;public&#39; AND indexname = &#39;applicants_sig_unique&#39;</span>
<span class="s2">      ) THEN</span>
<span class="s2">        CREATE UNIQUE INDEX applicants_sig_unique</span>
<span class="s2">        ON applicants (</span>
<span class="s2">          COALESCE(url, &#39;&#39;),</span>
<span class="s2">          COALESCE(program, &#39;&#39;),</span>
<span class="s2">          COALESCE(comments, &#39;&#39;)</span>
<span class="s2">        );</span>
<span class="s2">      END IF;</span>
<span class="s2">    END $$;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Main ETL entry-point</span>
<span class="c1"># ---------------------------------------------------------------------------</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../api.html#load_data.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jsonl_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load records from the LLM-extended JSONL file into PostgreSQL.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    app :</span>
<span class="sd">        Optional Flask app whose ``config[&quot;DATABASE_URL&quot;]`` overrides the</span>
<span class="sd">        default connection string.</span>
<span class="sd">    jsonl_path :</span>
<span class="sd">        Path to the JSONL file.  Defaults to ``LIV_LLM_JSONL``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">jsonl_path</span> <span class="ow">or</span> <span class="n">LIV_LLM_JSONL</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Missing JSONL at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Fix: copy module_2/llm_extend_applicant_data.json → module_4/data/&quot;</span>
        <span class="p">)</span>

    <span class="n">ensure_index</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="n">insert_sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    INSERT INTO applicants (</span>
<span class="s2">        program, comments, date_added, url,</span>
<span class="s2">        status, term, us_or_international,</span>
<span class="s2">        gpa, gre, gre_v, gre_aw,</span>
<span class="s2">        degree, llm_generated_program, llm_generated_university</span>
<span class="s2">    )</span>
<span class="s2">    VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">    ON CONFLICT DO NOTHING;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">inserted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">read_rows</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_conn</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">load_jsonl</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">read_rows</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">program</span>  <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;program&quot;</span><span class="p">))</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">))</span>
                <span class="n">url</span>      <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">))</span>
                <span class="n">date_added</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_added&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_added_raw&quot;</span><span class="p">))</span>

                <span class="n">deg</span>      <span class="o">=</span> <span class="n">normalize_degree</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;masters_or_phd&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;degree&quot;</span><span class="p">))</span>
                <span class="n">llm_prog</span> <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;llm-generated-program&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;llm_generated_program&quot;</span><span class="p">))</span>
                <span class="n">llm_uni</span>  <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;llm-generated-university&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;llm_generated_university&quot;</span><span class="p">))</span>

                <span class="n">status</span>   <span class="o">=</span> <span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">))</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">program</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">llm_prog</span><span class="p">,</span> <span class="n">llm_uni</span><span class="p">]))</span>

                <span class="n">term</span> <span class="o">=</span> <span class="n">extract_term</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">term</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">date_added</span> <span class="ow">and</span> <span class="n">date_added</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">2026</span><span class="p">:</span>
                    <span class="n">term</span> <span class="o">=</span> <span class="n">FALL_2026</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">extract_status</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
                <span class="n">us_intl</span> <span class="o">=</span> <span class="n">extract_us_intl</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
                <span class="n">gpa</span><span class="p">,</span> <span class="n">gre_q</span><span class="p">,</span> <span class="n">gre_v</span><span class="p">,</span> <span class="n">gre_aw</span> <span class="o">=</span> <span class="n">extract_gpa_gre</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_sql</span><span class="p">,</span> <span class="p">(</span>
                    <span class="n">program</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">date_added</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span>
                    <span class="n">status</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">us_intl</span><span class="p">,</span>
                    <span class="n">gpa</span><span class="p">,</span> <span class="n">gre_q</span><span class="p">,</span> <span class="n">gre_v</span><span class="p">,</span> <span class="n">gre_aw</span><span class="p">,</span>
                    <span class="n">deg</span><span class="p">,</span> <span class="n">llm_prog</span><span class="p">,</span> <span class="n">llm_uni</span><span class="p">,</span>
                <span class="p">))</span>
                <span class="n">inserted</span> <span class="o">+=</span> <span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== load_data.py completed ===&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Read rows  : </span><span class="si">{</span><span class="n">read_rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Inserted   : </span><span class="si">{</span><span class="n">inserted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">GradCafe Analytics</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview &amp; Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testing.html">Testing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operational_notes.html">Operational Notes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, JHU Software Concepts.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.0.4</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>